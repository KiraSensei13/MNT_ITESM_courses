---
title: "RNA-seq COVID"
author: "Antonio Osamu Katagiri Tanaka - A01212611@itesm.mx"
date: "April 17, 2020"
output:
  pdf_document: default
  html_notebook: default
  word_document: default
  html_document:
    df_print: paged
geometry: margin=1.75cm
classoption: a4paper
always_allow_html: yes
---

D. Blanco-Melo, B. Nilsson-Payant, W.-C. Liu, R. Moeller, M. Panis, D. Sachs, R. Albrecht, B.R. TenOever, SARS-CoV-2 launches a unique transcriptional signature from in vitro, ex vivo, and in vivo systems, BioRxiv. (2020) 2020.03.24.004655. [https://doi.org/10.1101/2020.03.24.004655](https://doi.org/10.1101/2020.03.24.004655).

```{r}
# Clear all objects (from the workspace)
rm(list = ls())

# Suppress Warning messages
options(warn = -1)

# Turn off scientific notation like 1e+06
options(stringsAsFactors = F)

# INSTALL with:

# if (!requireNamespace("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("GEOquery")
# BiocManager::install("DESeq2")
# BiocManager::install("limma")

# library(devtools)
# install_github("tpq/exprso")

# LOAD Libs
library(dplyr)
library(tidyverse)
library(DESeq2)
library(limma)

# LOAD provided functions
source("./script_ejercicios.R")
```

```{r}
datos <- load("./GSE147507_datos_covid.Rdata")

names(datos_covid)
dim(datos_covid)
head(datos_covid)
```

Cell Culture:
* Normal human bronchial epithelial (NHBE)
* Human adenocarcinomic alveolar basal epithelial (A549) cells

Viruses:
* SARS-related coronavirus 2 (SARS.CoV.2)
* influenza A/Puerto Rico/8/1934 (H1N1) virus (IAV)
* human respiratory syncytial virus (RSV)

# Filtrar genes con baja expresión y con bajos conteos

```{r}
# FILTRAR genes - conteos

# Para cada gen, contar el número de muestras con mayor a 5 conteos
datos_covid_filter <-
    apply(datos_covid, 1, function(x)
        length(which(x >= 5)))
table(datos_covid_filter)

# Filtrar genes con menor a 2 muestras con más de 5 conteos
datos_covid <- datos_covid[which(datos_covid_filter >= 2),]

# Let's take a LOOK
names(datos_covid)
dim(datos_covid)
head(datos_covid)
```

# Classify samples

SARS004_mock:
"SARS004_mock_3"
"SARS004_mock_2"
"SARS004_mock_1"

SARS004_CoV2:
"SARS004_CoV2_3"
"SARS004_CoV2_2"
"SARS004_CoV2_1"

CoV002.mock:
"CoV002.mock3.indexG3"
"CoV002.mock2.indexG2"
"CoV002.mock1.indexG1"

CoV002.CoV2:
"CoV002.CoV2.3.indexG6"
"CoV002.CoV2.2.indexG5"
"CoV002.CoV2.1.indexG4"

svRNA184.mock:
"svRNA184.mock.3.indexF3"
"svRNA184.mock.1.indexF1"

svRNA184.RSV:
"svRNA184.RSV.3.indexH9"
"svRNA184.RSV.1.indexF4"

X3_9_mock:
"X3_9_mock1_13"
"X3_9_mock2_14"

X3_9_wt:
"X3_9_wt1_15"
"X3_9_wt2_16"


```{r}
SARS004_mock  = datos_covid[,grep('SARS004_mock',  colnames(datos_covid))]
SARS004_CoV2  = datos_covid[,grep('SARS004_CoV2',  colnames(datos_covid))]

CoV002.mock   = datos_covid[,grep('CoV002.mock',   colnames(datos_covid))]
CoV002.CoV2   = datos_covid[,grep('CoV002.CoV2',   colnames(datos_covid))]

svRNA184.mock = datos_covid[,grep('svRNA184.mock', colnames(datos_covid))]
svRNA184.RSV  = datos_covid[,grep('svRNA184.RSV',  colnames(datos_covid))]

X3_9_mock     = datos_covid[,grep('X3_9_mock',     colnames(datos_covid))]
X3_9_wt       = datos_covid[,grep('X3_9_wt',       colnames(datos_covid))]
```

# Apply DESeq2 to SARS004 (SARS)

```{r}
tbl_merge = merge(SARS004_mock, SARS004_CoV2, by="row.names", all=TRUE)
rownames(tbl_merge) <- tbl_merge[,1] # First column contains the row names
tbl_merge = tbl_merge %>% select(-contains(c("Row.names"))) # DROP extra data
print(head(tbl_merge))

# Conteos
aux_classes = rep(0, times = ncol(tbl_merge)) # CLASSIFY infected samples as 0s
aux_classes[grep(pattern = "mock", x = colnames(tbl_merge))] = 1 # and mocks as 1s
aux_classes
colnames(tbl_merge)

count_results_SARS004 = DESeq_func(matrix_c = tbl_merge, classes_c = aux_classes)
count_results_SARS004 = count_results_SARS004[order(count_results_SARS004$pvalue),]
summary(count_results_SARS004)
head(count_results_SARS004)

# HISTOGRAM
pvals = count_results_SARS004["pvalue"]
hist(
    pvals[, 1],
    prob = TRUE,
    col = "black",
    border = "white",
    xlab = "scores",
    breaks = 100
)
box(bty = "l")
# Draw density function (assuming normal dist)
score_mean = mean(pvals[, 1])
score_sd   = sd(pvals[, 1])
curve(
    dnorm(x, mean = score_mean, sd = score_sd),
    add = TRUE,
    col = "red",
    lwd = 2
)

# Let's take a look to some genes
# count_mat_28v0["ENSG00000128567.16_PODXL",]
# count_mat_28v0["ENSG00000185559.14_DLK1",]
```

# Apply DESeq2 to CoV002 (SARS-related coronavirus 2)

```{r}
tbl_merge = merge(CoV002.mock, CoV002.CoV2, by="row.names", all=TRUE)
rownames(tbl_merge) <- tbl_merge[,1] # First column contains the row names
tbl_merge = tbl_merge %>% select(-contains(c("Row.names"))) # DROP extra data
print(head(tbl_merge))

# Conteos
aux_classes = rep(0, times = ncol(tbl_merge)) # CLASSIFY infected samples as 0s
aux_classes[grep(pattern = "mock", x = colnames(tbl_merge))] = 1 # and mocks as 1s
aux_classes
colnames(tbl_merge)

count_results_CoV002 = DESeq_func(matrix_c = tbl_merge, classes_c = aux_classes)
count_results_CoV002 = count_results_CoV002[order(count_results_CoV002$pvalue),]
summary(count_results_CoV002)
head(count_results_CoV002)

# HISTOGRAM
pvals = count_results_CoV002["pvalue"]
hist(
    pvals[, 1],
    prob = TRUE,
    col = "black",
    border = "white",
    xlab = "scores",
    breaks = 100
)
box(bty = "l")
# Draw density function (assuming normal dist)
score_mean = mean(pvals[, 1])
score_sd   = sd(pvals[, 1])
curve(
    dnorm(x, mean = score_mean, sd = score_sd),
    add = TRUE,
    col = "red",
    lwd = 2
)

# Let's take a look to some genes
# count_mat_28v0["ENSG00000128567.16_PODXL",]
# count_mat_28v0["ENSG00000185559.14_DLK1",]
```

# Apply DESeq2 to svRNA184 (human respiratory syncytial virus)

```{r}
tbl_merge = merge(svRNA184.mock, svRNA184.RSV, by="row.names", all=TRUE)
rownames(tbl_merge) <- tbl_merge[,1] # First column contains the row names
tbl_merge = tbl_merge %>% select(-contains(c("Row.names"))) # DROP extra data
print(head(tbl_merge))

# Conteos
aux_classes = rep(0, times = ncol(tbl_merge)) # CLASSIFY infected samples as 0s
aux_classes[grep(pattern = "mock", x = colnames(tbl_merge))] = 1 # and mocks as 1s
aux_classes
colnames(tbl_merge)

count_results_svRNA184 = DESeq_func(matrix_c = tbl_merge, classes_c = aux_classes)
count_results_svRNA184 = count_results_svRNA184[order(count_results_svRNA184$pvalue),]
summary(count_results_svRNA184)
head(count_results_svRNA184)

# HISTOGRAM
pvals = count_results_svRNA184["pvalue"]
hist(
    pvals[, 1],
    prob = TRUE,
    col = "black",
    border = "white",
    xlab = "scores",
    breaks = 100
)
box(bty = "l")
# Draw density function (assuming normal dist)
score_mean = mean(pvals[, 1])
score_sd   = sd(pvals[, 1])
curve(
    dnorm(x, mean = score_mean, sd = score_sd),
    add = TRUE,
    col = "red",
    lwd = 2
)

# Let's take a look to some genes
# count_mat_28v0["ENSG00000128567.16_PODXL",]
# count_mat_28v0["ENSG00000185559.14_DLK1",]
```

# Apply DESeq2 to X3_9 (influenza A/Puerto Rico/8/1934)

```{r}
tbl_merge = merge(X3_9_mock, X3_9_wt, by="row.names", all=TRUE)
rownames(tbl_merge) <- tbl_merge[,1] # First column contains the row names
tbl_merge = tbl_merge %>% select(-contains(c("Row.names"))) # DROP extra data
print(head(tbl_merge))

# Conteos
aux_classes = rep(0, times = ncol(tbl_merge)) # CLASSIFY infected samples as 0s
aux_classes[grep(pattern = "mock", x = colnames(tbl_merge))] = 1 # and mocks as 1s
aux_classes
colnames(tbl_merge)

count_results_X3_9 = DESeq_func(matrix_c = tbl_merge, classes_c = aux_classes)
count_results_X3_9 = count_results_X3_9[order(count_results_X3_9$pvalue),]
summary(count_results_X3_9)
head(count_results_X3_9)

# HISTOGRAM
pvals = count_results_X3_9["pvalue"]
hist(
    pvals[, 1],
    prob = TRUE,
    col = "black",
    border = "white",
    xlab = "scores",
    breaks = 100
)
box(bty = "l")
# Draw density function (assuming normal dist)
score_mean = mean(pvals[, 1])
score_sd   = sd(pvals[, 1])
curve(
    dnorm(x, mean = score_mean, sd = score_sd),
    add = TRUE,
    col = "red",
    lwd = 2
)

# Let's take a look to some genes
# count_mat_28v0["ENSG00000128567.16_PODXL",]
# count_mat_28v0["ENSG00000185559.14_DLK1",]
```

# Comparar CoV002 (SARS-related coronavirus 2) vs SARS004 (SARS), svRNA184 (human respiratory syncytial virus) y X3_9 (influenza A/Puerto Rico/8/1934)

```{r}
plotMA(count_results_CoV002, main = "CoV002")
plotMA(count_results_SARS004, main = "SARS004")
plotMA(count_results_svRNA184, main = "svRNA184")
plotMA(count_results_X3_9, main = "X3_9")

heatmap(as.matrix(datos_covid))
boxplot(log10(datos_covid), range=0, las=2)
```

TNFSF15 y EDN1 son los genes que están presentes al comparar SARS-CoV-2 con otros virus. DESeq2 muestra que los datos proporcionados sugieren que las drogas que aumentan la respuesta antiviral pueden ser una opción efectiva en el tratamiento de COVID-19.